{% import (
  "encoding/json/jsontext"
  "fmt"
  "net/url"
  "time"

  "github.com/google/uuid"

  "{{{ .Package }}}/app/controller/cutil"{{{ if .HasModule "jsonschema" }}}
  "{{{ .Package }}}/app/lib/jsonschema"{{{ end }}}
  "{{{ .Package }}}/app/util"{{{ if .HasModule "numeric" }}}
  "{{{ .Package }}}/app/util/numeric"{{{ end }}}
  "{{{ .Package }}}/views/components"
) %}

{% func Any(x any, ps *cutil.PageState) %}{% stripspace %}
  {% if x == nil %}
    <em>nil</em>
  {% else %}
    {% switch t := x.(type) %}
    {% case bool %}
      {%= Bool(t) %}
    {% case *bool %}
      {%= Bool(*t) %}
    {% case util.Diffs %}
      {%= Diffs(t) %}
    {% case float32 %}
      {%= Float(t) %}
    {% case *float32 %}
      {%= Float(*t) %}
    {% case float64 %}
      {%= Float(t) %}
    {% case *float64 %}
      {%= Float(*t) %}
    {% case int %}
      {%= Int(t) %}
    {% case *int %}
      {%= Int(*t) %}
    {% case int32 %}
      {%= Int(t) %}
    {% case *int32 %}
      {%= Int(*t) %}
    {% case int64 %}
      {%= Int(t) %}
    {% case *int64 %}
      {%= Int(*t) %}{{{ if .HasModule "jsonschema" }}}
    {% case *jsonschema.Schema %}
      {%= JSONSchema(t, true, ps) %}
    {% case jsonschema.Schemas %}
      {%= Any(util.ArrayToAnyArray(t), ps) %}{{{ end }}}
    {% case jsontext.Value %}
      {% code x, _ := util.FromJSONAny(t) %}
      {%= Any(x, ps) %}
    {% case util.ToOrderedMap[any] %}
      {%= OrderedMap(false, t.ToOrderedMap(), ps) %}
    {% case *util.OrderedMap[any] %}
      {%= OrderedMap(false, t, ps) %}
    {% case util.ToOrderedMapAny %}
      {%= OrderedMap(false, t.ToOrderedMapAny(), ps) %}
    {% case util.ToOrderedMaps[any] %}
      {%= OrderedMapArray(false, ps, t.ToOrderedMaps()...) %}
    {% case []*util.OrderedMap[any] %}
      {%= OrderedMapArray(false, ps, t...) %}
    {% case map[string]jsontext.Value %}
      {% code m, _ := util.FromJSONBytesMap[any](t) %}
      {%= Map(false, m, ps) %}
    {% case util.ToMap %}
      {%= Map(false, t.ToMap(), ps) %}
    {% case util.ValueMap %}
      {%= Map(false, t, ps) %}
    {% case map[string]any %}
      {%= Map(false, t, ps) %}
    {% case util.ToMaps %}
      {%= MapArray(false, ps, t.ToMaps()...) %}
    {% case []util.ValueMap %}
      {%= MapArray(false, ps, t...) %}{{{ if .HasModule "numeric" }}}
    {% case numeric.Numeric %}
      {%= Numeric(t) %}{{{ end }}}
    {% case util.Pkg %}
      {%= Package(t) %}
    {% case string %}
      {%= String(t) %}
    {% case *string %}
      {%= String(*t) %}
    {% case []string %}
      {%= StringArray(t) %}
    {% case time.Time %}
      {%= Timestamp(&t) %}
    {% case *time.Time %}
      {%= Timestamp(t) %}
    {% case url.URL %}
      {%= URL(t, "", true, ps) %}
    {% case *url.URL %}
      {%= URL(*t, "", true, ps) %}
    {% case uuid.UUID %}
      {%= UUID(&t) %}
    {% case *uuid.UUID %}
      {%= UUID(t) %}
    {% case []any %}
      {%- if len(t) == 0 -%}
        <em>empty array</em>
      {%- else -%}
        {% code arr, extra := util.ArrayLimit(t, 8) %}
        {%- for idx, e := range arr -%}
          <div class="flex bb">
            <div class="mts mrs mbs"><em>{%d idx + 1 %}</em></div>
            <div class="mts mbs full-width">{%= Any(e, ps) %}</div>
          </div>
        {%- endfor -%}
        {% if extra > 0 %}
          <div class="mts"><em>...and{% space %}{%d extra %}{% space %}more</em></div>
        {% endif %}
      {%- endif -%}
    {% case fmt.Stringer %}
      {%= String(t.String()) %}
    {% default %}
      unhandled type [{%s fmt.Sprintf("%T", x) %}]
    {% endswitch %}
  {% endif %}
{% endstripspace %}{% endfunc %}

{% func AnyTable(title string, value any, indent int, ps *cutil.PageState) %}{% stripspace %}
  <tr>
    {%= components.Indent(true, indent + 1) %}
    <th class="shrink">{%s title %}</th>
    {%= components.Indent(true, indent + 1) %}
    <td>{%= Any(value, ps) %}</td>
  {%= components.Indent(true, indent) %}
  </tr>
{% endstripspace %}{% endfunc %}
